# Module 5: Parallelizing Analysis Operations
# Lab: Parallelizing analysis operations

### Scenario
After pondering and examining the flight delay data, you decide that it is time to focus on a more specific problem:

*If I fly from A to B by airline C in the morning/afternoon/evening of day X in month Y, what is the probability that the flight will be delayed, and for how long?*

This is a complex question that depends on a number of variables, so you decide to break it down into smaller elements. Initially, you focus on the phrase "*If I fly from A to B by airline C … ?*" To help solve this part of the equation, you want to find the number of times these flights are delayed, and by how long. You realize that you can perform the processing for this problem using parallel nodes, so you decide to write a PEMA class to help you.

### Objectives
In this lab, you will create a PEMA object that you can use to examine flight delay data.

### Lab Setup
Estimated Time: 90 minutes
Username: **Adatum\\AdatumAdmin**
Password: **Pa55w.rd**

Before starting this lab, ensure that the following VMs are all running:
-  MT17B-WS2016-NAT
-  20773A-LON-DC
-  20773A-LON-DEV
-  20773A-LON-RSVR
-  20773A-LON-SQLR

## Exercise 1: Capturing flight delay times and frequencies

### Scenario
The PEMA class that you will develop analyzes flights made between two selected airports by a specified airline. The airports and airline will be passed to the PEMA object as parameters. The result generated by the PEMA object will comprise a list containing:
-  The total number of flights made by the selected airline from the first airport to the second.
-  The number of these flights that were delayed.
-  The delay times for the delayed flights.

The main tasks for this exercise are as follows:
1. Create a shared folder
2. Copy the data
3. Create the class generator for the PemaFlightDelays class
4. Test the PemaFlightDelays class using a data frame
5. Use the PemaFlightDelays class to analyze XDF data

#### Task 1: Create a shared folder
If you have not already created the **\\\\LON-RSVR\\Data** share in an earlier lab, perform the following steps:
1.  Log in to the LON-RSVR VM as **Adatum\\AdatumAdmin** with the password **Pa55w.rd**.
2.  Using File Explorer, create a new folder named **C:\\Data**.
3.  Create a network share for the **C:\\Data** folder. This share should provide read and write access for **Everyone**. Name the share **\\\\LON-RSVR\\Data**.

#### Task 2: Copy the data
1.  Log in to the **LON-DEV** VM as **Adatum\\AdatumAdmin** with the password **Pa55w.rd**.
2.  Copy the file **FlightDelayData.xdf** from the **E:\\Labfiles\\Lab05** folder to the **\\\\LON-RSVR\\Data** share.
3.  Close the command prompt window.

#### Task 3: Create the class generator for the PemaFlightDelays class
01. Start your R development environment of choice (Visual Studio Tools, or RStudio), and create a new R file.
02. Install the **dplyr** package.
03. Bring the **dplyr** and **RevoPemaR** libraries into scope.
04. Create a new class generator named **PremaFlightDelays** using the **setPemaClass** function. This class should inherit from the **PemaBaseClass** class.
05. Define the following fields:
 -  **totalFlights**: numeric
 -  **totalDelays**: numeric
 -  **origin**: character
 -  **dest**: character
 -  **airline**: character
 -  **delayTimes**: vector
 -  **results**: list
06. Add the **initialize** method to the **methods** list for the class. This method should take three parameters: **originCode**, **destinationCode**, and **airlineCode**. These parameters will be used to specify the origin, destination, and airline to use for retrieving flight delay information. They should all default to the empty string.
In the body of the initialize method, perform the following tasks:
 -  Activate the PEMA framework:
    ```
	callSuper(...) usingMethods(.pemaMethods)
    ```
 -  Initialize **totalFlights** and **totalDelays** to zero.
 -  Set **delayTimes** to be a zero-length numeric vector.
 -  Initialize **origin** using the **originCode** parameter.
 -  Initialize **dest** using the **destinationCode** parameter.
 -  Initialize **airline** using the **airlineCode** parameter.
07. Define the **processData** method.
This method should take a single parameter named **dataList**. This parameter will either contain a data frame or a list of vectors, depending on whether the PEMA object is run against a data frame or an XDF object.
In this method, perform the following tasks:
 -  Coerce the **dataList** parameter into a data frame if it is not there already.
 -  If the **origin** field contains an empty string, the user didn't provide this information as a parameter when running the object. In this case, populate the origin with the first value found in the **Origin** variable in the data frame.
 -  Likewise, populate the **dest** and **airline** fields using the first values found in the **Dest** and **UniqueCarrier** variables of the data frame.
 -  Filter the data frame to find all flights that match the combination specified by the values in the **origin**, **dest**, and **airline** fields.
 -  Count the number of flights matched and add this figure to the **totalFlights** field.
 -  From this dataset, find all flights with a delay time of more than zero minutes and append these delay times to the **delayTimes** vector.
 -  Count the number of delayed flights and add this figure to the **totalDelays** field.
08. Define the **updateResults** method.
This method should take a single parameter named **pemaFlightDelaysObj**. This parameter contains a reference to another instance of the PEMA object that has been running on another node. In this method, perform the following tasks:
 -  Add the value found in **pemaFlightDelaysObj$totalFlights** to the **totalFlights** field.
 -  Add the value found in **pemaFlightDelaysObj$totalDelays** to the **totalDelays** field.
 -  Append the data found in the **pemaFlightDelaysObj$delayTimes** vector to the **delayTimes** field.
09. Define the **processResults** method.
This method should not take any parameters. In this method, perform the following tasks:
 -  Construct the **results** list. This list should have three elements named **NumberOfFlights**, **NumberOfDelays**, and **DelayTimes**. Store the value from the **totalFlights** field in the **NumberOfFlights** element. Store the value from the **totalDelays** field in the **NumberOfDelays** element. Copy the **delayTimes** vector to the **DelayTimes** element.
 -  Return the **results** list.
10. Run the code to create the **PremaFlightDelays** class.

#### Task 4: Test the PemaFlightDelays class using a data frame
01. Create an instance of the **PemaFlightDelays** class in a variable named **pemaFlightDelaysObj** using the **PemaFlightDelays** class generator.
02. Start a remote session on the LON-RSVR VM. When prompted, specify the username **admin**, and the password **Pa55w.rd**.
03. At the REMOTE\> prompt, temporarily pause the remote session and return to the local session running on the LON-DEV VM.
04. Copy the local object, **pemaFlightDelaysObj**, to the remote session. Use the **putLocalObject** function to do this.
05. Resume the remote session.
06. In the remote session, install the **dplyr** package, and bring the **dplyr** and **RevoPemaR** libraries into scope.
07. Create a data frame containing the first 50,000 observations from the **FlightDelayData.xdf** file in the \\\\LON-RSVR\\Data share.
08. Use the **pemaCompute** function to run an analysis of flight delays using the **pemaFlightDelaysObj** object. Specify an origin of "ABE", a destination of "PIT", and the airline "US".
09. Display the results. They should indicate that there were 755 matching flights, of which 188 were delayed. The delay times for each delayed flight should also appear.
10. Display the contents of the internal fields of the **pemaFlightDelaysObj** object. They should contain the following values:
 -  **delayTimes**: a list of 188 integers showing the delay times for each delayed flight.
 -  **totalDelays**: 188
 -  **totalFlights**: 755
 -  **origin**: ABE
 -  **dest**: PIT
 -  **airline**: US

#### Task 5: Use the PemaFlightDelays class to analyze XDF data
1.  Create an XDF file containing the first 50,000 observations of the flight delay data. Specify a small block size of 5000 rows. This will help to ensure that the data is presented to the PEMA object as several chunks, for testing purposes. Note that in the previous case, when using a data frame, chunking does not occur and the PEMA object receives all of the data in one go.
2.  Repeat the analysis performed in the previous exercise using this XDF file. Verify that the results are the same as those generated using the data frame.
3.  Perform an analysis of flights from **LAX** to **JFK** made by airline **DL** using the entire dataset in the **FlightDelayData.xdf** file.
4.  Save the script as **Lab5Script.R** in the **E:\\Labfiles\\Lab05** folder, and close your R development environment.

**Results**: At the end of this exercise, you will have created and run a PEMA class that finds the number of times flights that match a specified origin, destination, and airline are delayed—and how long each delay was.

**Question:** How many flights were made from LAX to JFK by DL, and how many were delayed? What was the longest delay?

**Question:** How could you verify that the results produced by the **PemaFlightDelays** object are correct?

©2017 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.
